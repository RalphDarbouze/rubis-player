<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>üì∫ RUBIS TV PLAYER</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* [Previous CSS styles remain exactly the same] */
  </style>
</head>
<body>

  <!-- [Previous HTML structure remains exactly the same] -->

  <script>
    const video = document.getElementById('video');
    const speedTest = document.getElementById('speedTestResult');
    const speedWarning = document.getElementById('speedWarning');
    const progressContainer = document.getElementById('progressContainer');
    const speedProgress = document.getElementById('speedProgress');
    const DEFAULT_M3U_URL = "https://gist.githubusercontent.com/RalphDarbouze/7fc242ebfecbba4f6854becb8b8abc94/raw/ea72074575541484197cddb7d5aa60a78005fba4/my_first_iptv.m3u";

    let hls, channels = [], userSpeedMbps = 0;
    let speedTestInProgress = false;
    let abortController = null;

    const qualitySpeeds = {
      "280p": 0.3,
      "360p": 0.7,
      "SD": 1.5,
      "480p": 2,
      "540p": 3,
      "HD": 5,
      "720p": 5,
      "1080p": 8,
      "Full HD": 8,
      "4K": 20
    };

    window.onload = () => {
      loadDefaultPlaylist();
    };

    async function runSpeedTest() {
      if (speedTestInProgress) {
        if (abortController) {
          abortController.abort();
        }
        return;
      }

      speedTestInProgress = true;
      speedTest.textContent = "‚è≥ Test de vitesse en cours...";
      speedWarning.textContent = "";
      progressContainer.style.display = "block";
      speedProgress.style.width = "0%";

      // Try multiple test file sources in case one fails
      const testFiles = [
        "https://speedtest.ftp.otenet.gr/files/test1Mb.db", // 1MB
        "https://speedtest.ftp.otenet.gr/files/test10Mb.db", // 10MB
        "https://download.microsoft.com/download/8/7/5/875B7A4D-2345-4D1A-8B9E-1D38B6F26950/ENU/x64/Latest/MSSTSC.EXE" // ~1MB
      ];

      let testSuccessful = false;
      
      for (const fileUrl of testFiles) {
        abortController = new AbortController();
        
        try {
          const startTime = performance.now();
          const response = await fetch(fileUrl, {
            cache: "no-store",
            signal: abortController.signal,
            mode: 'cors'
          });

          if (!response.ok) continue;
          
          const contentLength = response.headers.get('content-length');
          const testSize = contentLength ? parseInt(contentLength) : 1000000; // Default to 1MB if unknown
          
          let received = 0;
          const reader = response.body.getReader();
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            received += value.length;
            const progress = Math.min(100, (received / testSize) * 100);
            speedProgress.style.width = `${progress}%`;
            
            // Calculate current speed
            const currentTime = performance.now();
            const elapsedSeconds = (currentTime - startTime) / 1000;
            if (elapsedSeconds > 0) {
              const currentSpeed = (received * 8) / (elapsedSeconds * 1000000); // Mbps
              speedTest.textContent = `üöÄ Vitesse actuelle: ${currentSpeed.toFixed(2)} Mbps`;
            }
          }

          const endTime = performance.now();
          const durationSeconds = (endTime - startTime) / 1000;
          userSpeedMbps = (testSize * 8) / (durationSeconds * 1000000);
          
          speedTest.textContent = `üöÄ Vitesse: ${userSpeedMbps.toFixed(2)} Mbps`;
          testSuccessful = true;
          break;
          
        } catch (error) {
          if (error.name === 'AbortError') {
            speedTest.textContent = "Test annul√©";
            break;
          }
          console.log(`Test failed with ${fileUrl}, trying next...`, error);
          continue;
        }
      }

      if (!testSuccessful) {
        speedTest.textContent = "‚ùå √âchec du test de vitesse";
        userSpeedMbps = 0;
      }

      speedTestInProgress = false;
      progressContainer.style.display = "none";
      abortController = null;
      updateChannelQualityWarning();
    }

    // [Rest of the functions remain exactly the same: loadDefaultPlaylist, parseM3U, detectQuality, 
    // updateChannelList, changeChannel, updateChannelQualityWarning]
    
  </script>
</body>
</html>
