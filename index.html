<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test de Vitesse Internet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
      background: #f7f7f7;
    }

    h1 {
      color: #333;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    #speedTest, #speedWarning {
      margin-top: 1em;
      font-size: 18px;
    }

    #progressContainer {
      width: 100%;
      background: #ddd;
      height: 20px;
      border-radius: 10px;
      margin-top: 10px;
      overflow: hidden;
      display: none;
    }

    #speedProgress {
      background: #28a745;
      height: 100%;
      width: 0%;
      transition: width 0.2s ease;
    }
  </style>
</head>
<body>
  <h1>Test de Vitesse Internet</h1>
  <button onclick="runSpeedTest()">Lancer le test</button>
  <div id="speedTest">Vitesse : -- Mbps</div>
  <div id="speedWarning"></div>
  <div id="progressContainer">
    <div id="speedProgress"></div>
  </div>

  <script>
    let speedTestInProgress = false;
    let abortController = null;
    let userSpeedMbps = 0;

    async function runSpeedTest() {
      const speedTest = document.getElementById("speedTest");
      const speedWarning = document.getElementById("speedWarning");
      const progressContainer = document.getElementById("progressContainer");
      const speedProgress = document.getElementById("speedProgress");

      if (speedTestInProgress) {
        if (abortController) abortController.abort();
        speedTest.textContent = "Test annul√©.";
        return;
      }

      speedTestInProgress = true;
      speedTest.textContent = "‚è≥ Test de vitesse en cours...";
      speedWarning.textContent = "";
      progressContainer.style.display = "block";
      speedProgress.style.width = "0%";

      // üîΩ File for testing from a CDN with CORS support
      const testFile = {
        url: "https://speed.cloudflare.com/__down?bytes=5000000", // 5MB file
        size: 5 * 1024 * 1024 // in bytes
      };

      abortController = new AbortController();

      try {
        const startTime = performance.now();
        const response = await fetch(testFile.url, {
          cache: "no-store",
          signal: abortController.signal,
          mode: "cors"
        });

        if (!response.ok || !response.body) throw new Error("Fichier inaccessible");

        const reader = response.body.getReader();
        let received = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          received += value.length;
          const progress = Math.min(100, (received / testFile.size) * 100);
          speedProgress.style.width = `${progress}%`;

          const elapsedSeconds = (performance.now() - startTime) / 1000;
          if (elapsedSeconds > 0) {
            const currentSpeedMbps = (received * 8) / (elapsedSeconds * 1_000_000);
            speedTest.textContent = `üöÄ Vitesse actuelle : ${currentSpeedMbps.toFixed(2)} Mbps`;
          }
        }

        const endTime = performance.now();
        const totalSeconds = (endTime - startTime) / 1000;
        userSpeedMbps = (testFile.size * 8) / (totalSeconds * 1_000_000);
        speedTest.textContent = `‚úÖ Vitesse finale : ${userSpeedMbps.toFixed(2)} Mbps`;

      } catch (error) {
        console.error("Erreur du test :", error);
        speedTest.textContent = "‚ùå √âchec du test de vitesse.";
        userSpeedMbps = 0;
      } finally {
        speedTestInProgress = false;
        abortController = null;
        progressContainer.style.display = "none";
        showSpeedWarning();
      }
    }

    function showSpeedWarning() {
      const speedWarning = document.getElementById("speedWarning");

      if (userSpeedMbps < 1) {
        speedWarning.textContent = "‚ö†Ô∏è Connexion tr√®s lente ‚Äî usage limit√©.";
        speedWarning.style.color = "red";
      } else if (userSpeedMbps < 3) {
        speedWarning.textContent = "‚ö†Ô∏è Connexion moyenne ‚Äî appels ou vid√©os risqu√©s.";
        speedWarning.style.color = "orange";
      } else {
        speedWarning.textContent = "‚úÖ Connexion rapide ‚Äî tout fonctionne normalement.";
        speedWarning.style.color = "green";
      }
    }
  </script>
</body>
</html>


